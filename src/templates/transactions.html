{% extends "base.html" %}

{% block title %}All Transactions{% endblock %}
{% block page_title %}Transaction History{% endblock %}
{% block page_subtitle %}<p class="text-muted mb-0">View and manage all your transactions</p>{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-funnel me-2"></i>Filters
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter" onchange="loadTransactions()">
                            <option value="">All categories</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="perPage" class="form-label">Per Page</label>
                        <select class="form-select" id="perPage" onchange="loadTransactions()">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="loadTransactions()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                        </button>
                    </div>
                    <div class="col-md-5 text-end">
                        <button id="deleteSelectedBtn" type="button" class="btn btn-outline-danger" onclick="deleteSelectedTransactions()" style="display: none;">
                            <i class="bi bi-trash me-2"></i>Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list me-2"></i>Transactions
                <span id="totalTransactionsBadge" class="badge bg-primary ms-2">Loading...</span>
            </div>
            <div class="card-body p-0">
                <div id="loadingTransactions" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading transactions...</p>
                </div>
                
                <div id="transactionsTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="width: 100px;">Date</th>
                                    <th>Description</th>
                                    <th style="width: 120px;">Amount</th>
                                    <th style="width: 150px;">Category</th>
                                    <th style="width: 60px;" title="Classification Confidence">
                                        <i class="bi bi-shield-check"></i>
                                    </th>
                                    <th style="width: 120px;">Reference</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="noTransactionsMessage" style="display: none;" class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <h4 class="mt-3 text-muted">No transactions found</h4>
                    <p class="text-muted">Try adjusting your filters or import some transaction data.</p>
                    <a href="{{ url_for('import_csv') }}" class="btn btn-primary">
                        <i class="bi bi-upload me-2"></i>Import Transactions
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <div id="paginationContainer" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
            <div>
                <span id="paginationInfo" class="text-muted"></span>
            </div>
            <div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let categories = [];
    let transactions = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        loadTransactions();
    });
    
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            categories = data.categories || [];
            
            // Populate category filter
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    async function loadTransactions(page = 1) {
        currentPage = page;
        const perPage = document.getElementById('perPage').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        const loadingDiv = document.getElementById('loadingTransactions');
        const tableDiv = document.getElementById('transactionsTable');
        const noDataDiv = document.getElementById('noTransactionsMessage');
        const paginationDiv = document.getElementById('paginationContainer');
        
        // Show loading
        loadingDiv.style.display = 'block';
        tableDiv.style.display = 'none';
        noDataDiv.style.display = 'none';
        paginationDiv.style.display = 'none';
        
        try {
            const params = new URLSearchParams({
                page: page,
                per_page: perPage
            });
            
            if (categoryFilter) {
                params.append('category', categoryFilter);
            }
            
            const response = await fetch(`/api/transactions?${params}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            transactions = data.transactions || [];
            const total = data.total || 0;
            totalPages = Math.ceil(total / perPage);
            
            // Update badge
            document.getElementById('totalTransactionsBadge').textContent = `${total} transactions`;
            
            // Hide loading
            loadingDiv.style.display = 'none';
            
            if (transactions.length > 0) {
                renderTransactionsTable();
                renderPagination(total, perPage);
                tableDiv.style.display = 'block';
                paginationDiv.style.display = 'flex';
            } else {
                noDataDiv.style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error loading transactions:', error);
            loadingDiv.style.display = 'none';
            noDataDiv.style.display = 'block';
            showToast('Error loading transactions: ' + error.message, 'danger');
        }
    }
    
    function getConfidenceIndicator(confidence, method) {
        if (confidence === null || confidence === undefined) {
            return '<span class="text-muted" title="No confidence data"><i class="bi bi-dash"></i></span>';
        }
        
        let icon, color, title;
        
        if (confidence >= 0.8) {
            icon = 'bi-shield-check';
            color = 'text-success';
            title = `High confidence (${(confidence * 100).toFixed(0)}%)`;
        } else if (confidence >= 0.5) {
            icon = 'bi-shield-exclamation';
            color = 'text-warning';
            title = `Medium confidence (${(confidence * 100).toFixed(0)}%)`;
        } else {
            icon = 'bi-shield-x';
            color = 'text-danger';
            title = `Low confidence (${(confidence * 100).toFixed(0)}%)`;
        }
        
        if (method) {
            title += ` - ${method}`;
        }
        
        return `<span class="${color}" title="${title}"><i class="bi ${icon}"></i></span>`;
    }

    function renderTransactionsTable() {
        const tbody = document.getElementById('transactionsTableBody');
        
        const rows = transactions.map(tx => {
            const categoryBadge = tx.category === 'Uncategorized' ? 
                `<span class="badge bg-warning">${tx.category}</span>` :
                `<span class="badge bg-success">${tx.category}</span>`;
            
            const confidenceIndicator = getConfidenceIndicator(tx.classification_confidence, tx.classification_method);
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input transaction-checkbox" 
                               value="${tx.id}" onchange="updateSelectedCount()">
                    </td>
                    <td>
                        <small class="text-muted">${tx.date}</small>
                    </td>
                    <td>
                        <div class="fw-medium">${tx.description}</div>
                    </td>
                    <td>
                        <span class="${tx.amount < 0 ? 'text-danger' : 'text-success'} fw-bold">
                            ${Math.abs(tx.amount).toLocaleString('sv-SE')} SEK
                        </span>
                    </td>
                    <td>
                        ${categoryBadge}
                    </td>
                    <td class="text-center">
                        ${confidenceIndicator}
                    </td>
                    <td>
                        <small class="text-muted font-monospace">${tx.verifikationsnummer || '-'}</small>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="deleteTransaction(${tx.id})" title="Delete transaction">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = rows;
        updateSelectedCount();
    }
    
    function renderPagination(total, perPage) {
        const info = document.getElementById('paginationInfo');
        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(currentPage * perPage, total);
        info.textContent = `Showing ${start}-${end} of ${total} transactions`;
        
        const pagination = document.getElementById('pagination');
        const pages = [];
        
        // Previous button
        if (currentPage > 1) {
            pages.push(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadTransactions(${currentPage - 1})">Previous</a>
                </li>
            `);
        }
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            pages.push(`
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a>
                </li>
            `);
        }
        
        // Next button
        if (currentPage < totalPages) {
            pages.push(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadTransactions(${currentPage + 1})">Next</a>
                </li>
            `);
        }
        
        pagination.innerHTML = pages.join('');
    }
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
        
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = selectedCheckboxes.length;
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const selectedCountSpan = document.getElementById('selectedCount');
        
        selectedCountSpan.textContent = count;
        
        if (count > 0) {
            deleteBtn.style.display = 'inline-block';
        } else {
            deleteBtn.style.display = 'none';
        }
        
        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        if (allCheckboxes.length > 0) {
            if (count === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (count > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
    }

    async function deleteTransaction(transactionId) {
        const transaction = transactions.find(tx => tx.id === transactionId);
        const description = transaction ? transaction.description : `Transaction ${transactionId}`;
        
        if (!confirm(`Are you sure you want to delete this transaction?\n\n"${description}"\n\nThis action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/transactions/${transactionId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            showToast('Transaction deleted successfully', 'success');
            loadTransactions(currentPage); // Reload current page
            
        } catch (error) {
            console.error('Error deleting transaction:', error);
            showToast('Error deleting transaction: ' + error.message, 'danger');
        }
    }

    async function deleteSelectedTransactions() {
        const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        
        if (selectedIds.length === 0) {
            showToast('No transactions selected', 'warning');
            return;
        }
        
        const confirmMessage = `Are you sure you want to delete ${selectedIds.length} selected transaction(s)?\n\nThis action cannot be undone.`;
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            const response = await fetch('/api/transactions/delete/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transaction_ids: selectedIds
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            showToast(`Successfully deleted ${data.deleted_count} transaction(s)`, 'success');
            
            // Clear all checkboxes
            document.getElementById('selectAllCheckbox').checked = false;
            document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = false);
            
            loadTransactions(currentPage); // Reload current page
            
        } catch (error) {
            console.error('Error deleting transactions:', error);
            showToast('Error deleting transactions: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %}
