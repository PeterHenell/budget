{% extends "base.html" %}

{% block title %}Background Tasks{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-tasks mr-2"></i>
                Background Tasks
            </h2>
            
            <!-- Information Section -->
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle mr-2"></i>
                    Background Task Management
                </h6>
                <p class="mb-2">
                    This page shows the status and history of all background tasks. To start new tasks, use the appropriate pages:
                </p>
                <ul class="mb-0">
                    <li><strong>Auto-Classification:</strong> Use the "Auto-Classify" buttons on the <a href="/import_csv">Import CSV</a> or <a href="/uncategorized">Uncategorized</a> pages</li>
                    <li><strong>Future Tasks:</strong> Additional background tasks will be available from their respective pages</li>
                </ul>
            </div>
            
            <!-- Currently Running Task -->
            <div id="running-task-section" style="display: none;" class="mb-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            Currently Running
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="running-task-content">
                            <!-- Running task details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Running Task Section (shown when no tasks are running) -->
            <div id="no-running-task-section" class="mb-4">
                <div class="card border-secondary">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle mr-2 text-success"></i>
                            No Tasks Running
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-0">
                            All background tasks are complete. Start new tasks from the Import CSV or Uncategorized pages.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Task History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history mr-2"></i>
                        Task History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="tasks-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Task</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Created</th>
                                    <th>Duration</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body">
                                <!-- Task rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="task-details-content">
                <!-- Task details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let refreshInterval;
let isRefreshing = false;

function formatDuration(startTime, endTime) {
    if (!startTime || !endTime) return '-';
    const start = new Date(startTime);
    const end = new Date(endTime);
    const duration = end - start;
    const seconds = Math.floor(duration / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
    } else {
        return `${seconds}s`;
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString();
}

function getStatusBadge(status) {
    const badges = {
        'pending': 'badge-secondary',
        'running': 'badge-info',
        'completed': 'badge-success',
        'failed': 'badge-danger'
    };
    const badgeClass = badges[status] || 'badge-secondary';
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

function getProgressBar(progress, total) {
    if (total === 0) return '-';
    const percentage = Math.round((progress / total) * 100);
    const progressClass = percentage === 100 ? 'bg-success' : 'bg-primary';
    
    return `
        <div class="progress" style="height: 20px;">
            <div class="progress-bar ${progressClass}" role="progressbar" 
                 style="width: ${percentage}%" 
                 aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="${total}">
                ${percentage}%
            </div>
        </div>
    `;
}

function showTaskDetails(taskId) {
    fetch(`/api/background-tasks/${taskId}`)
    .then(response => response.json())
    .then(task => {
        const content = document.getElementById('task-details-content');
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>ID:</strong></td><td>${task.id}</td></tr>
                        <tr><td><strong>Type:</strong></td><td>${task.task_type}</td></tr>
                        <tr><td><strong>Name:</strong></td><td>${task.task_name}</td></tr>
                        <tr><td><strong>Status:</strong></td><td>${getStatusBadge(task.status)}</td></tr>
                        <tr><td><strong>Progress:</strong></td><td>${task.progress}/${task.total}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Timestamps</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Created:</strong></td><td>${formatDateTime(task.created_at)}</td></tr>
                        <tr><td><strong>Started:</strong></td><td>${formatDateTime(task.started_at)}</td></tr>
                        <tr><td><strong>Completed:</strong></td><td>${formatDateTime(task.completed_at)}</td></tr>
                        <tr><td><strong>Duration:</strong></td><td>${formatDuration(task.started_at, task.completed_at)}</td></tr>
                    </table>
                </div>
            </div>
            
            ${task.current_item ? `
                <div class="row">
                    <div class="col-12">
                        <h6>Current Item</h6>
                        <p class="text-muted">${task.current_item}</p>
                    </div>
                </div>
            ` : ''}
            
            ${task.error_message ? `
                <div class="row">
                    <div class="col-12">
                        <h6>Error Message</h6>
                        <div class="alert alert-danger">${task.error_message}</div>
                    </div>
                </div>
            ` : ''}
            
            ${task.result_data ? `
                <div class="row">
                    <div class="col-12">
                        <h6>Result Data</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(task.result_data, null, 2)}</pre>
                    </div>
                </div>
            ` : ''}
        `;
        
        $('#taskDetailsModal').modal('show');
    })
    .catch(error => {
        showAlert('Error loading task details: ' + error.message, 'danger');
    });
}

function refreshTasks() {
    if (isRefreshing) return;
    isRefreshing = true;
    
    fetch('/api/background-tasks')
    .then(response => response.json())
    .then(data => {
        // Update running task section
        const runningTask = data.running_task;
        const runningSection = document.getElementById('running-task-section');
        const runningContent = document.getElementById('running-task-content');
        const noRunningSection = document.getElementById('no-running-task-section');
        
        if (runningTask) {
            runningSection.style.display = 'block';
            noRunningSection.style.display = 'none';
            runningContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>${runningTask.task_name}</h6>
                        <p class="mb-2">${runningTask.current_item || 'Processing...'}</p>
                        ${getProgressBar(runningTask.progress, 100)}
                    </div>
                    <div class="col-md-4 text-right">
                        <small class="text-muted">Started: ${formatDateTime(runningTask.started_at)}</small>
                    </div>
                </div>
            `;
        } else {
            runningSection.style.display = 'none';
            noRunningSection.style.display = 'block';
        }
        
        // Update tasks table
        const tbody = document.getElementById('tasks-table-body');
        tbody.innerHTML = '';
        
        data.tasks.forEach(task => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${task.id}</td>
                <td>${task.task_name}</td>
                <td>${task.task_type}</td>
                <td>${getStatusBadge(task.status)}</td>
                <td>${task.total > 0 ? getProgressBar(task.progress, task.total) : '-'}</td>
                <td>${formatDateTime(task.created_at)}</td>
                <td>${formatDuration(task.started_at, task.completed_at)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showTaskDetails(${task.id})">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error refreshing tasks:', error);
    })
    .finally(() => {
        isRefreshing = false;
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshTasks();
    
    // Set up auto-refresh every 2 seconds
    refreshInterval = setInterval(refreshTasks, 2000);
});

// Clean up interval when page is unloaded
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
